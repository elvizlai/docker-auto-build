ARG VERSION=8.2

# https://docs.redis.com/latest/modules/
# https://hub.docker.com/r/redislabs/redisgraph/tags https://redis.io/docs/stack/graph/
FROM redislabs/redisgraph:2.12.10 AS redisgraph

# https://github.com/alibaba/TairString
FROM tairmodule/tairstring:latest AS tairstring
# https://github.com/alibaba/TairZset
FROM tairmodule/tairzset:latest AS tairzset

# Tairhash + ReDe compile
# https://github.com/alibaba/TairHash
# https://github.com/TamarLabs/ReDe
FROM redis:${VERSION} AS tairhash
RUN set -ex; \
    \
    BUILD_DEPS=' \
        ca-certificates \
        cmake \
        gcc \
        git \
        g++ \
        make \
        curl \
    '; \
    apt-get update; \
    apt-get install -y $BUILD_DEPS --no-install-recommends; \
    rm -rf /var/lib/apt/lists/*; \
    git clone "https://github.com/alibaba/TairHash.git"; \
    cd TairHash; \
    mkdir -p build; \
    cd build; \
    cmake -DSORT_MODE=yes ..; \
    make -j; \
    cd ..; \
    cp lib/tairhash_module.so /usr/local/lib/; \
    curl -sSL -o /usr/local/lib/rede.so https://github.com/TamarLabs/ReDe/releases/download/v0.5.0/module.so; \
    chmod +x /usr/local/lib/*.so

# redis release
FROM redis:${VERSION}

ARG DEPS="ca-certificates libgomp1"
ENV LIBDIR=/opt/modules

# Required to perform privileged actions
USER 0

RUN set -ex; \
    apt-get update; \
	apt-get install -y --no-install-recommends ${DEPS}; \
    mkdir -p ${LIBDIR};

COPY --from=redisgraph /usr/lib/redis/modules/redisgraph.so ${LIBDIR}
COPY --from=tairhash /usr/local/lib/rede.so ${LIBDIR}/rede.so
COPY --from=tairstring /usr/local/lib/tairstring_module.so ${LIBDIR}/tairstring.so
COPY --from=tairhash /usr/local/lib/tairhash_module.so ${LIBDIR}/tairhash.so
COPY --from=tairzset /usr/local/lib/tairzset_module.so ${LIBDIR}/tairzset.so

# modify /usr/local/bin/docker-entrypoint.sh to password
RUN sed -i '/exec "\$@"/i\
if [ -z "\$REDIS_PASSWORD" ] && [ "\$ALLOW_EMPTY_PASSWORD" != "yes" ]; then\n\
    echo >&2 "ERROR: Please set REDIS_PASSWORD or using ALLOW_EMPTY_PASSWORD=yes to allow empty password.";\n\
    exit 1;\n\
fi;\n\
if [ -n "\$REDIS_PASSWORD" ]; then\n\
    set -- "\$@" --requirepass "\$REDIS_PASSWORD";\n\
fi\n' `which docker-entrypoint.sh`
